<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>.Net WS-Federation</title>
<link rel="stylesheet" type="text/css" href="../../style.css" />
<script type="text/javascript" src="../../utilities.js">
</script>
</head>
<body>
<h1>static void</h1>
<div class="menu">
<ul>
<li><a href="../../index.html">Main &gt;</a></li>
<li><a href="../dotnet.html">.Net &gt;</a></li>
<li><a href="dotnetcollections.html">Collections</a></li>
<li><a href="events.html">Events</a></li>
<li><a href="globaldotnet.html">Globalization</a></li>
<li><a href="reflection.html">Reflection</a></li>
<li><a href="dotnetsecurity.html">Security</a></li>
<li><a href="claims.html">Claims Security</a></li>
<li><a href="wsfederation.html">WS-Federation</a></li>
<li><a href="wsfederationconfig.html">WS-Federation Config</a></li>
<li><a href="dotnetsecurity_crypto.html">Crypto+ signing</a></li>
<li><a href="serialization.html">Serialization</a></li>
<li><a href="dotnetthreads.html">Threading</a></li>
<li><a href="async.html">Async</a></li>
</ul>

</div>
<div class="content">
<h2>WS-Federation</h2>
<p>Support for WS-Federation is based on .net 4.5 <a href="claims.html">Claims Security</a>. Claims-based identity means an application (<strong>Relying Party</strong>, RP) uses a separate service (<strong>Security Token Service</strong>, STS / <strong>Identity Provider</strong>, IdP) for security.</p>
<p>See <a href="claims.html">Claims Security</a> for basics on ClaimsPrincipal and <a href="wsfederationconfig.html">WS-Federation Config</a> for application configuration.</p>

<h3>Definitions</h3>
<ul>
<li><strong>Claim</strong> - Statement about a user, with type, value and issuer. Eg "Name"="Martin".
<ul>
<li>Claim may use standard typenames from OASIS/SAML (URIs like http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name ). See WIF ClaimTypes class.</li>
</ul>
</li>
<li><strong>Security Token</strong> - A signed list of claims.<ul>
<li>Typically is <strong>SAML</strong> (xml format with signature, defined by OASIS) or <strong>JWT (Json Web Token)</strong></li>
<li>Compare to a simple Kerberos ticket in AD.</li>
<li>Note you may have multiple "name" claims, from one issuer and/or multiple issuers.</li>
</ul></li>
<li><strong>Identity Provider</strong> (IdP) knows about the user. The user logs on to the IdP and gets a token.<ul>
<li>Active Directory Federation Service (ADFS) is one IdP.  Others are Azure AD, Oracle Identity Manager, PingFederate ...</li>
<li>In Windows Server 2012, you can add additional claims to the name/groupSids of a normal Windows Identity (active directory administrative center- Dynamic Acces Control - Claims Types)</li>
</ul></li>
<li><strong>Security Token Service</strong> (STS) - the part of the IdP that generates security tokens.</li>
<li><strong>Relying Party</strong> (RP) - the application that uses claims <ul>
<li>The Rp has a URI called a <strong>realm</strong> which the IdP must know.</li>
<li>In .net the application uses <strong>WIF</strong> to define the claims it trusts, and process the claims.</li>
</ul></li>
</ul>

<h3>Tooling</h3>
<ul>
<li>VS2012 had <a href="http://visualstudiogallery.msdn.microsoft.com/e21bf653-dfe1-4d81-b3d3-795cb104066e">the Identity Access Tool</a> which included a local STS. </li>
<li>VS2013 project create wizard has "Configure Authentication". wsFederation is "Organizational Accounts".</li>
<li>There is no local STS but there is a <a href="http://www.nuget.org/packages/Thinktecture.IdentityModel.EmbeddedSts/">Nuget EmbeddedSts</a> (<a href="https://github.com/thinktecture/Thinktecture.IdentityModel/wiki/EmbeddedSts">github docs</a>)</li>
<li>See also <a href="http://thinktecture.github.io/Thinktecture.IdentityServer.v2/">Identity Server v2</a> or a real STS like ADFS or Azure AD</li>
</ul>

<h3>Pipeline</h3>
<p>There are two ASP HttpModules required for WIF.</p>
<p>The <strong>WSFederationAuthenticationModule (FAM)</strong> reacts to unauthorized requests and forwards to the IdP STS. When the STS redirects back with a token, it creates the principal and claims.</p>
<p>The <strong>SessionAuthenticationModule (SAM)</strong> persists the principal and claims to a cookie, and rehydrates it on each application AuthorizeRequest.</p>
<div class="alert">By default SessionAuthentication only works over SSL.<br/>
Relax that with system.identityModel.services/ federationConfiguration/ cookieHandler @requireSsl="false"</div>

<ul>
<li>Sessions have fixed expirations by default. Do a sliding expiration using the SessionSecurityTokenReceived event (the eventArgs has a ReissueCookie=true)</li>
<li>Cookies are NOT WebFarm safe by default (use DPAPI).<br/>
To use machinekey, there is a built-in one:<br/>
system.identityModel/identityConfiguration/securityTokenHandlers/remove SessionSecurityTokenHandler and add MachineKeySessionSecurityTokenHandler</li>
<li>You can cache in server rather than in cookie: sessionToken.IsReferenceMode = true<br/>
By default caches in memory. To change it (AppFabric or Redis) derive from SessionSecurityTokenCache and add in identityConfiguration/caches/sessionSecurityTokenCache @type</li>
</ul>
<h3>Claims Transformation</h3>
<p>The IdP claims may be useful for authentication, but may not be directly relevant to the application's authorization. You can transform the claims by deriving from ClaimsAuthenticationManager and overriding Authenticate.</p>
<div class="code">
<p><span style="color: blue;">public</span> <span style="color: blue;">class</span> <span style="color: #2b91af;">ClaimsTransformer</span> : <span style="color: #2b91af;">ClaimsAuthenticationManager</span><br />
{<br />
&nbsp;&nbsp;&nbsp; <span style="color: blue;">public</span> <span style="color: blue;">override</span> <span style="color: #2b91af;">ClaimsPrincipal</span> Authenticate(<span style="color: blue;">string</span> resourceName, <span style="color: #2b91af;">ClaimsPrincipal</span> incomingPrincipal)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green;">//not authenticated- skip it</span><br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (!incomingPrincipal.Identity.IsAuthenticated)<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> incomingPrincipal;<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green;">//validation</span><br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (!incomingPrincipal.HasClaim(<span style="color: #2b91af;">ClaimTypes</span>.Country, <span style="color: #a31515;">"USA"</span>))<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">throw</span> <span style="color: blue;">new</span> <span style="color: #2b91af;">SecurityException</span>(<span style="color: #a31515;">"Only Americans allowed"</span>);<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; }<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">if</span> (incomingPrincipal.HasClaim(<span style="color: #a31515;">"Transformed"</span>, <span style="color: #a31515;">"1"</span>))<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> incomingPrincipal;<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green;">//transformation of claims</span><br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> claimsList = <span style="color: blue;">new</span> <span style="color: #2b91af;">List</span>&lt;<span style="color: #2b91af;">Claim</span>&gt;<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">new</span> <span style="color: #2b91af;">Claim</span>(<span style="color: #2b91af;">ClaimTypes</span>.Name, incomingPrincipal.Identity.Name),<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green;">//database look up?</span><br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">new</span> <span style="color: #2b91af;">Claim</span>(<span style="color: #2b91af;">ClaimTypes</span>.Role, <span style="color: #a31515;">"American"</span>),<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">new</span> <span style="color: #2b91af;">Claim</span>(<span style="color: #2b91af;">ClaimTypes</span>.Country, <span style="color: #a31515;">"USA"</span>),<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green;">//transformed marker</span><br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">new</span> <span style="color: #2b91af;">Claim</span>(<span style="color: #a31515;">"Transformed"</span>, <span style="color: #a31515;">"1"</span>),<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; };<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> cId = <span style="color: blue;">new</span> <span style="color: #2b91af;">ClaimsIdentity</span>(claimsList, <span style="color: #a31515;">"Application"</span>);<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> claimsPrincipal = <span style="color: blue;">new</span> <span style="color: #2b91af;">ClaimsPrincipal</span>(cId);<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green;">//save it in a token (chunked into cookies)</span><br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> sessionToken = <span style="color: blue;">new</span> <span style="color: #2b91af;">SessionSecurityToken</span>(claimsPrincipal);<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green;">//to store in claims in server-side memory and just issue a cookie key...</span><br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: green;">//sessionToken.IsReferenceMode = true; //liable to apdomain recycles, not webfarm friendly!!</span><br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">FederatedAuthentication</span>.SessionAuthenticationModule.WriteSessionTokenToCookie(sessionToken);<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <span style="color: blue;">return</span> claimsPrincipal;<br />
&nbsp;&nbsp;&nbsp; }<br />
}</p>
</div>
<p>You can hook this up is Application_PostAuthenticateRequest or just in login action </p>
<div class="code">
<p><span style="color: blue;">protected</span> <span style="color: blue;">void</span> Application_PostAuthenticateRequest(<span style="color: #2b91af;">Object</span> sender, <span style="color: #2b91af;">EventArgs</span> e)<br />
{<br />
&nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> principal = <span style="color: #2b91af;">ClaimsPrincipal</span>.Current;<br />
&nbsp;&nbsp;&nbsp; <span style="color: green;">//if it's registered in web.config, you can grab it here</span><br />
&nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> claimsAuthenticationManager = <span style="color: #2b91af;">FederatedAuthentication</span>.FederationConfiguration.<br />
&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; IdentityConfiguration.ClaimsAuthenticationManager;<br />
&nbsp;&nbsp;&nbsp; <span style="color: green;">//otherwise just new it up</span><br />
&nbsp;&nbsp;&nbsp; claimsAuthenticationManager = <span style="color: blue;">new</span> <span style="color: #2b91af;">ClaimsTransformer</span>();<br />
&nbsp;&nbsp;&nbsp; <span style="color: green;">//transform it</span><br />
&nbsp;&nbsp;&nbsp; <span style="color: blue;">var</span> transformed = claimsAuthenticationManager.Authenticate(<span style="color: blue;">string</span>.Empty, principal);<br />
&nbsp;&nbsp;&nbsp; <span style="color: green;">//save it</span><br />
&nbsp;&nbsp;&nbsp; <span style="color: #2b91af;">Thread</span>.CurrentPrincipal = <span style="color: #2b91af;">HttpContext</span>.Current.User = transformed;<br />
}</p>
</div>



</div>
<div class="Footer">

</div>
</body>
</html>